---
title: "GGP-GGS izlases sagatavošana"
subtitle: "Latvija, 2025"
author: "Mārtiņš Liberts"
date: today
format:
  html:
    embed-resources: true
    page-layout: full
    toc: true
    toc-depth: 2
    toc-title: Satura rādītājs
execute:
  echo: false
lang: lv-LV
language: 
  title-block-author-single: "Autors"
  title-block-published: "Datums"
---

# Latvijas privāto mājokļu ietvara sagatavošana

## Dati no CSP par pastāvīgi apdzīvotiem privātajiem mājokļiem

No CSP ir saņemts privāto mājokļu ietvars, kas ietver visus Latvijas privātos mājokļus ar vismaz vienu pastāvīgo mājokļa iedzīvotāju.

```{r CSP frame}
#| output: false
library(data.table)
library(gt)
library(purrr)

frame_csp <- fread(
  file = file.path(config::get("dir.data"), "frame_csp.csvy.gz"),
  yaml = TRUE
)

# Trim
frame_csp[, pers_kopa_trim := fifelse(pers_sk < 10L, pers_sk, 10L)]
frame_csp[, pers_1859_trim := fifelse(pers_sk_1859 < 10L, pers_sk_1859, 10L)]

frame_csp[, pers_kopa_trim := factor(pers_kopa_trim, 0:10, c(0:9, "10+"))]
frame_csp[, pers_1859_trim := factor(pers_1859_trim, 0:10, c(0:9, "10+"))]

oc.rate <- frame_csp[, round(100 * sum(pers_sk_1859 == 0L) / .N, 1)]
```

Katram mājoklim ir zināms kopīgais pastāvīgo iedzīvotāju skaits, kā arī iedzīvotāju skaits vecumā 18--59 gadi, kas ir GGS mērķa populācija.

Ietvarā ir `r frame_csp[, prettyNum(.N, big.mark = ",")]` mājokļi, no kuriem `r frame_csp[, prettyNum(sum(pers_sk_1859 == 0L), big.mark = ",")]` (`r oc.rate` %) mājokļos nav reģistrēta neviena persona vecumā 18--59 gadi.

**Ierosinājums (saskaņots 2025-06-10):** GGS populācijas ietvarā ietvert tikai tos privātos mājokļus, kuros ir reģistrēta vismaz viena persona vecumā 18--59 gadi. Tādi kopā ir `r prettyNum(frame_csp[, sum(pers_sk_1859 > 0L)], big.mark = ",")` mājokļi.

**Apsvērumi:**

- GGS populācijas ietvarā saglabājot visus privātos mājokļus ir sagaidāms augsts virspārklājums (apsekojumam nederīgi mājokļi). Sagaidāmais virspārklājums būtu `r oc.rate` %.
- Ir jāņem vērā, ka šādā veidā mēs potenciāli palielinām GGS mērķa populācijas nenoklājumu (personas vecumā 18--59 gadi), jo diezgan droši daļā no izslēgtajiem mājokļiem būs tādi, kuros faktiski dzīvo GGS mērķa populācijai piederošas personas. Šobrīd nav iespējams novērtēt ietekmi uz nenoklājumu. Mērķa populācijas kopīgo nenoklājumu var vērtēt pēc GGS apsekojuma datu savākšanas.

```{r CSP tables}
tab_csp <- frame_csp[, .(n = .N), keyby = .(pers_kopa_trim, pers_1859_trim)]
tab_csp[, p := prop.table(n)]

tab_csp <- rbindlist(
  list(
    tab_csp,
    tab_csp[, map(.SD, sum), .SDcols = c("n", "p"), keyby = .(pers_kopa_trim)],
    tab_csp[, map(.SD, sum), .SDcols = c("n", "p"), keyby = .(pers_1859_trim)],
    tab_csp[, map(.SD, sum), .SDcols = c("n", "p")]
  ),
  fill = TRUE
)

tab_csp[is.na(pers_kopa_trim), pers_kopa_trim := "Kopā"]
tab_csp[is.na(pers_1859_trim), pers_1859_trim := "Kopā"]

tab_csp_n <- dcast.data.table(
  tab_csp,
  pers_kopa_trim ~ pers_1859_trim,
  value.var = "n"
)

tab_csp_p <- dcast.data.table(
  tab_csp,
  pers_kopa_trim ~ pers_1859_trim,
  value.var = "p"
)

gt(tab_csp_n) |>
  tab_caption("Privāto mājokļu skaits") |>
  tab_spanner(
    label = "Mājokļa personu skaits vecumā 18--59",
    columns = matches("\\d")
  ) |>
  cols_label(
    pers_kopa_trim = "Personu skaits mājoklī"
  ) |>
  cols_width(
    everything() ~ pct(100 / 13)
  ) |>
  fmt_number(decimals = 0) |>
  sub_missing(missing_text = "") |>
  tab_style(
    style = cell_fill(color = "#f0f0f0"),
    locations = cells_body(columns = "0")
  ) |>
  tab_options(
    table.width = pct(100),
    quarto.disable_processing = TRUE
  )

gt(tab_csp_p) |>
  tab_caption("Privāto mājokļu skaita īpatsvars") |>
  tab_spanner(
    label = "Mājokļa personu skaits vecumā 18--59",
    columns = matches("\\d")
  ) |>
  cols_label(
    pers_kopa_trim = "Personu skaits mājoklī"
  ) |>
  cols_width(
    everything() ~ pct(100 / 13)
  ) |>
  fmt_number(decimals = 2) |>
  sub_missing(missing_text = "") |>
  tab_style(
    style = cell_fill(color = "#f0f0f0"),
    locations = cells_body(columns = "0")
  ) |>
  tab_options(
    table.width = pct(100),
    quarto.disable_processing = TRUE
  )
```

## VZD Adrešu reģistra teksta dati

VZD dati tiek iegūti no <a href="https://data.gov.lv/dati/lv/dataset/varis-atvertie-dati" target="_blank">Latvijas Atvērto datu portāla</a>.


```{r VZD}
tab_vzd <- fread(
  file = file.path(config::get("dir.data"), "tab_vzd.csvy"),
  yaml = TRUE
)
```

Kopā VZD datos pēc datu apstrādes ir `r tab_vzd[, prettyNum(sum(N), big.mark = ",")]` adresācijas objekti. Ņemt vērā, ka šie dati satur visus adresācijas objektus - tai skaitā industriālās ēkas un neapdzīvotus mājokļus.

```{r VZD table}
gt(tab_vzd) |>
  tab_caption("Adresācijas objekti VZD Adrešu reģistra datos") |>
  cols_label(
    tips_cd = "Kods",
    tips_cd_nos = "Adresācijas objekta tips",
    N = "Skaits"
  ) |>
  grand_summary_rows(
    columns = "N",
    fns = Kopā ~ sum(.),
    fmt = ~ fmt_number(., decimals = 0)
  ) |>
  fmt_number(decimals = 0) |>
  tab_options(
    quarto.disable_processing = TRUE
  )
```


## Teritoriju kodi

Teritoriālo vienību, administratīvo teritoriju, reģionu un apkaimju kodi tiek pievienoti no Atvērto datu portāla:

- <a href="https://data.gov.lv/dati/dataset/robezas" target="_blank">Ģeneralizētas teritoriālo vienību robežas</a>
- <a href="https://data.gov.lv/dati/lv/dataset/apkaimes" target="_blank">Pilsētu apkaimes</a>


## GGS populācijas mājokļu ietvara sagatavošana

CSP mājokļu ietvars satur `r frame_csp[, prettyNum(sum(pers_sk_1859 > 0), big.mark = ",")]` mājokļos, kuros ir reģistrētas `r frame_csp[, prettyNum(sum(pers_sk_1859), big.mark = ",")]` personas vecumā 18--59 gadi.

Pirmajā solī no ietvara tiek dzēstas personas, kuras ir reģistrētas:

- ciemā - adrese ir norādīta tikai līdz ciemam (tips `106`),
- adreses, kas ir likvidētas (statuss `DEL`) vai kļūdainas (statuss `ERR`).

```{r GGS del1}
frame_majo_del1 <- fread(
  file = file.path(config::get("dir.data"), "frame_majo_del1.csvy.gz"),
  yaml = TRUE
)

frame_majo_del1[
  pers_sk_1859 > 0,
  .(
    majo_sk = .N,
    pers_sk_1859 = sum(pers_sk_1859)
  ),
  keyby = .(tips_cd, tips_cd_nos, statuss)
] |> gt() |>
  tab_caption("No ietvara izslēgti mājokļi un personas pirmajā solī") |>
  cols_label(
    tips_cd = "Tips (kods)",
    tips_cd_nos = "Tips (nosaukums)",
    statuss = "Statuss",
    majo_sk = "Mājokļu skaits",
    pers_sk_1859 = "Personu skaits (18--59)"
  ) |>
  grand_summary_rows(
    columns = c("majo_sk", "pers_sk_1859"),
    fns = Kopā ~ sum(.),
    fmt = ~ fmt_number(., decimals = 0)
  ) |>
  fmt_number(decimals = 0) |>
  tab_options(
    quarto.disable_processing = TRUE
  )
```

Otrajā solī no ietvara tiek dzēstas personas, kuras ir reģistrētas ēkā ar vairākiem dzīvokļiem, bet personas reģistrētā adrese ir norādīta tikai līdz ēkai -- nav zināms, kurā ēkas dzīvoklī persona ir reģistrēta.

```{r GGS del2}
frame_majo_del2 <- fread(
  file = file.path(config::get("dir.data"), "frame_majo_del2.csvy.gz"),
  yaml = TRUE
)

frame_majo_del2[
  pers_sk_1859 > 0,
  .(
    majo_sk = .N,
    pers_sk_1859 = sum(pers_sk_1859)
  ),
  keyby = .(tips_cd, tips_cd_nos, statuss)
] |> gt() |>
  tab_caption("No ietvara izslēgti mājokļi un personas otrajā solī") |>
  cols_label(
    tips_cd = "Tips (kods)",
    tips_cd_nos = "Tips (nosaukums)",
    statuss = "Statuss",
    majo_sk = "Mājokļu skaits",
    pers_sk_1859 = "Personu skaits (18--59)"
  ) |>
  grand_summary_rows(
    columns = c("majo_sk", "pers_sk_1859"),
    fns = Kopā ~ sum(.),
    fmt = ~ fmt_number(., decimals = 0)
  ) |>
  fmt_number(decimals = 0) |>
  tab_options(
    quarto.disable_processing = TRUE
  )
```

```{r frame GGS}
frame_majo <- fread(
  file = file.path(config::get("dir.data"), "frame_majo.csvy.gz"),
  yaml = TRUE
)
```

Rezultātā GGS mājokļu ietvarā ir iekļauti **`r frame_majo[, prettyNum(.N, big.mark = ",")]` mājokļi**, kuros ir reģistrētas **`r frame_majo[, prettyNum(sum(pers_sk_1859), big.mark = ",")]` personas** vecumā 18--59 gadi.

